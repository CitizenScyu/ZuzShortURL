name: SLSA3 provenance for GitHub auto-generated tarball

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  download:
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - uses: robinraju/release-downloader@v1.8
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*.tar.gz"
      - id: hash
        run: echo "hashes=$(sha256sum *.tar.gz | base64 -w0)" >> "$GITHUB_OUTPUT"

  provenance:
    needs: [download]
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: ${{ needs.download.outputs.hashes }}
      upload-assets: true
